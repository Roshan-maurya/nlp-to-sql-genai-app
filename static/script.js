// static/script.js

async function postJSON(url, data) {
  const res = await fetch(url, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  });
  return res.json();
}

// Render table from backend result
function renderTable(data) {
  // console.log("Render:", data);

  const container = document.getElementById('result');
  container.innerHTML = '';

  if (!data) {
    container.innerHTML = '<div class="alert alert-info">No result</div>';
    return;
  }

  if (data.error) {
    container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
    return;
  }

  const cols = data.columns || [];
  const rows = data.rows || [];

  if (rows.length === 0) {
    container.innerHTML = '<div class="alert alert-info">No rows found</div>';
    return;
  }

  const table = document.createElement('table');
  table.className = 'table table-bordered table-striped table-hover';

  // Table header
  const thead = document.createElement('thead');
  const trHead = document.createElement('tr');
  cols.forEach(c => {
    const th = document.createElement('th');
    th.innerText = c;
    trHead.appendChild(th);
  });
  thead.appendChild(trHead);
  table.appendChild(thead);

  // Table body
  const tbody = document.createElement('tbody');
  rows.forEach(row => {
    const tr = document.createElement('tr');
    cols.forEach(c => {
      const td = document.createElement('td');
      td.innerText = row[c] ?? '';
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);

  container.appendChild(table);
}

// ------------------------------
// PROMPT → SQL → RESULT
// ------------------------------
document.getElementById('ask').addEventListener('click', async () => {
  const prompt = document.getElementById('prompt').value.trim();
  if (!prompt) { alert('Type a prompt'); return; }

  document.getElementById('result').innerHTML =
    '<div class="spinner-border text-primary" role="status"></div>';

  try {
    const r = await postJSON('/ask', { prompt });

    // console.log("Prompt Response:", r);

    // show SQL generated by AI
    document.getElementById('generated-sql').innerText = r.sql || '';

    // render table directly from r (NOT r.result)
    renderTable(r);

  } catch (err) {
    document.getElementById('result').innerHTML =
      `<div class="alert alert-danger">Error: ${err}</div>`;
  }
});

// ------------------------------
// MANUAL SQL
// ------------------------------
document.getElementById('run-sql').addEventListener('click', async () => {
  const sql = document.getElementById('sql').value.trim();
  if (!sql) { alert('Type SQL'); return; }

  document.getElementById('result').innerHTML =
    '<div class="spinner-border text-primary" role="status"></div>';

  try {
    const r = await postJSON('/ask', { use_sql: true, sql });

    // console.log("SQL Response:", r);

    document.getElementById('generated-sql').innerText = r.sql || sql;

    // render table directly from r (NOT r.result)
    renderTable(r);

  } catch (err) {
    document.getElementById('result').innerHTML =
      `<div class="alert alert-danger">Error: ${err}</div>`;
  }
});
